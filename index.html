<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
    <title>Personnal Trainer</title>
</head>
<body>

<div class="container col-lg-3">
    <div class="row py-4 gy-2">
        <h1 class="text-center">Personnal Trainer</h1>
        <div class="col-xs-12">
            <label for="liste-voix" class="form-label">Choix de la voix</label>
            <select id="liste-voix"  class="form-select"></select>
        </div>
        <div class="col-xs-12">
            <label for="liste-voix" class="form-label">Choix du programme</label>
            <select id="liste-trainning" class="form-select"></select>
        </div>
    </div>


    <div class="row">
        <div class="col">
            <button id="btnStart" class="col btn btn-success" onclick="startTrainning();">Start Trainning</button>
        </div>
        <div class="col">
            <button id="btnPause" class="col btn btn-warning disabled" onclick="pauseTrainning();">Pause</button>
            <button id="btnStop" class="col btn btn-danger disabled" onclick="stopTrainning();">Stop</button>
        </div>
    </div>
    <div class="row">
        <p id="sceance" class="text-center fw-bold pt-4"></p>
    </div>
    <div class="row border align-items-center mx-4">
        <div id="temps" class="display-1 text-center py-4">00:00</div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj"
        crossorigin="anonymous"></script>

<script>
    var synth = window.speechSynthesis;

    var inputForm = document.querySelector('form');
    var inputTxt = document.querySelector('.txt');
    var voiceSelect = document.querySelector('#liste-voix');
    var trainningSelect = document.querySelector('#liste-trainning');

    var pitch = document.querySelector('#pitch');
    var pitchValue = document.querySelector('.pitch-value');
    var rate = document.querySelector('#rate');
    var rateValue = document.querySelector('.rate-value');

    var voices = [];

    var listeProgramme = [
        {
            libelle: 'TEST',
            etapes: [
                {
                    ordre: 1,
                    libelle: 'Echaufement, 3 minutes à allure modérée, sans cale-pieds, résistance 1',
                    duree: 10,
                },
                {
                    ordre: 2,
                    libelle: 'Echaufement, 2 minutes à allure modérée, avec cale-pieds, résistance à 3',
                    duree: 10,
                },
                {
                    ordre: 3,
                    libelle: 'Coeur de séance, 45 minutes à allure modérée à 60% de la FC MAX',
                    duree: 10,
                },
            ]
        },
        {
            libelle: 'Rameur',
            etapes: [
                {
                    ordre: 1,
                    libelle: 'Echaufement, 3 minutes à allure modérée, sans cale-pieds, résistance 1',
                    duree: 180,
                },
                {
                    ordre: 2,
                    libelle: 'Echaufement, 2 minutes à allure modérée, avec cale-pieds, résistance à 3',
                    duree: 120,
                },
                {
                    ordre: 3,
                    libelle: 'Coeur de séance, 45 minutes à allure modérée à 60% de la FC MAX',
                    duree: 2700,
                },
                {
                    ordre: 4,
                    libelle: 'Retour au calme, 10 min de rameur à allure lente',
                    duree: 600,
                },
            ]
        },
        {
            libelle: 'Rameur Séance « endurance longue »',
            etapes: [
                {
                    ordre: 1,
                    libelle: 'Echaufement partie 1',
                    duree: 300,
                },
                {
                    ordre: 2,
                    libelle: 'Echaufement partie 2',
                    duree: 180,
                },
                {
                    ordre: 3,
                    libelle: 'Echaufement partie 3',
                    duree: 120,
                },
                {
                    ordre: 4,
                    libelle: 'Coeur de séance ',
                    duree: 1800,
                },
                {
                    ordre: 5,
                    libelle: 'Retour au calme',
                    duree: 600,
                },
            ]
        },
    ];

    function ditUnePhrase(text) {
        var utterThis = new SpeechSynthesisUtterance(text);
        var selectedOption = voiceSelect.selectedOptions[0].getAttribute('data-name');
        for (i = 0; i < voices.length; i++) {
            if (voices[i].name === selectedOption) {
                utterThis.voice = voices[i];
            }
        }
        utterThis.pitch = 1;
        utterThis.rate = 1;
        synth.speak(utterThis);

        return utterThis;
    }

    var etape = 0;
    var timerStart = 0;
    var timer = 0;
    var car = 0;
    var interval = null;
    let isEnCours = false;
    let isPaused = false;


    function stopTrainning() {
        isEnCours = false;
        clearInterval(interval);
        gestionBtn();
        car = 0;
        timerDisplay()
    }
    function pauseTrainning() {
        isPaused = !isPaused;
        gestionBtn();
    }

    function startTrainning(idProg) {

        isEnCours = true;
        timerStart = Math.round(new Date().getTime() / 1000);

        gestionBtn();

        programme = listeProgramme[trainningSelect.selectedOptions[0].value];
        etape = 0;
        timer = 0;
        car = 0;
        interval = null;
        let texte = "Démarrage de l'entrainement " + programme.libelle;
        let speechTitle = ditUnePhrase(texte);

        speechTitle.onend = () => {
            let speechLibelle = ditUnePhrase(programme.etapes[etape].libelle);
            libelleDisplay(programme.etapes[etape].libelle);
            car = programme.etapes[etape].duree;
            speechLibelle.onend = ()=>{
                timerLoop();
            }
        };
    }

    function timerLoop()
    {
        interval = setInterval(() => {

            if (isPaused) return isPaused;
            if (!isEnCours) return isEnCours;

            car -= 1;
            timerDisplay();

            milestone();

            if (handleSteps()) return true;

        }, 1000);

    }

    function handleSteps()
    {
        if (car === 0)
        {
            etape++;
            if (programme.etapes[etape] === undefined) {
                ditUnePhrase("Fin de la scéance ! Bien joué.");
                libelleDisplay("Fin de la scéance ! Bien joué.");
                stopTrainning();
                return true;
            } else {
                isPaused = true;
                car = programme.etapes[etape].duree;
                let speechLibelle = ditUnePhrase(programme.etapes[etape].libelle);
                speechLibelle.onend = ()=>{
                    isPaused = false;
                }
                libelleDisplay(programme.etapes[etape].libelle);
                timer = 1;
            }
        }
    }

    function milestone()
    {
        // if(programme.etapes[etape] === undefined) return true;
        switch (car) {
            case Math.round(programme.etapes[etape].duree) - 1:
                ditUnePhrase("C'est parti");
                break;
            case Math.round(programme.etapes[etape].duree / 2):
                ditUnePhrase("On est à la moitiée");
                break;
            case 3:
                // ditUnePhrase(car);
                ditUnePhrase(car);
                break;
            case 2:
                ditUnePhrase(car);
                break;
            case 1:
                ditUnePhrase(car);
                break;
            case 0:
                ditUnePhrase("Stop");
                break;
        }
    }

    function timerDisplay()
    {
        document.getElementById("temps").innerText = secToTime(car);
    }

    function libelleDisplay(text)
    {
        document.getElementById("sceance").innerText = text;
    }

    function secToTime(sec) {
        let m = Math.round(sec / 60) % 60;
        let s = sec % 60;
        return m.toString().padStart(2, '0') + ":" + s.toString().padStart(2, '0');


    }

    function populateVoiceList() {
        voices = synth.getVoices();

        for (let i = 0; i < voices.length; i++) {
            let option = document.createElement('option');
            option.textContent = voices[i].name + ' (' + voices[i].lang + ')';

            if (voices[i].default) {
                option.textContent += ' -- DEFAULT';
            }

            option.setAttribute('data-lang', voices[i].lang);
            option.setAttribute('data-name', voices[i].name);
            if (voices[i].lang === 'fr-FR') {
                option.selected = true;
            }
            voiceSelect.appendChild(option);
        }
    }

    function populateTrainningList() {

        for (let i = 0; i < listeProgramme.length; i++) {
            let option = document.createElement('option');
            option.textContent = listeProgramme[i].libelle;

            option.value = i;

            trainningSelect.appendChild(option);
        }
    }

    populateTrainningList();
    populateVoiceList();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoiceList;
    }


    function gestionBtn(){
        var btnStart = document.getElementById("btnStart");
        var btnPause = document.getElementById("btnPause");
        var btnStop = document.getElementById("btnStop");

        if (isEnCours){
            btnStart.classList.add("disabled");
            btnPause.classList.remove("disabled");
            btnStop.classList.remove("disabled");
        }else {
            btnStart.classList.remove("disabled");
            btnPause.classList.add("disabled");
            btnStop.classList.add("disabled");
        }

        if (isPaused) {
            btnPause.innerText = "Play";
        } else {
            btnPause.innerText = "Pause";
        }
    }

</script>


</body>
</html>
