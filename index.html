<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">

    <title>Personnal Trainer</title>

    <style>
        .progress-ring__circle {
            transition: stroke-dashoffset 1s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
    </style>
</head>
<body>

<div class="container col-lg-6">
    <div class="row py-4 gy-2">
        <h1 class="text-center">Personnal Trainer</h1>
        <div class="col-xs-12">
            <label for="liste-voix" class="form-label">Choix de la voix</label>
            <select id="liste-voix" class="form-select"></select>
        </div>
        <div class="col-10">
            <label for="liste-trainning" class="form-label">Choix du programme</label>
            <select id="liste-trainning" class="form-select"></select>
        </div>
        <div class="row col-2 align-items-end justify-content-center">
            <div class="col">
                <a href="addProgram.html" class="btn btn-info">+</a>
            </div>
        </div>

    </div>

    <div class="row">
        <div class="col">
            <button id="btnStart" class="col btn btn-success" onclick="startTrainning();">Start Trainning</button>
        </div>
        <div class="col">
            <button id="btnPause" class="col btn btn-warning disabled" onclick="pauseTrainning();">Pause</button>
            <button id="btnStop" class="col btn btn-danger disabled" onclick="stopTrainning();">Stop</button>
        </div>
    </div>
    <div class="row">
        <p id="sceance" class="text-center fw-bold pt-4"></p>
    </div>
    <div class="row" style="height: 300px">
        <div class="position-relative">
            <div class="position-absolute top-50 start-50 translate-middle">
                <progress-ring class="top-50 start-50" stroke="30" radius="150" progress="0" strokeColor="#9aa7f0"></progress-ring>
            </div>
            <div class="position-absolute top-50 start-50 translate-middle">
                <div id="temps" class="fs-1 fw-bold text-muted">00:00</div>
            </div>
        </div>
    </div>
    <div class="row border border-danger align-items-center mx-4">
        <div id="log" class="py-4">
            <div class="row">
                <div class="col">
                    <p>Car : </p>
                    <p id="car"></p>
                </div>
                <div class="col">
                    <p>carFoisTps : </p>
                    <p id="carFoisTps"></p>
                </div>
                <div class="col">
                    <p>pSecFoisTpsFloor : </p>
                    <p id="carFoisTpsFloor"></p>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj"
        crossorigin="anonymous"></script>

<script src="components/ProgressRing.js"></script>

<script>

    window.customElements.define('progress-ring', ProgressRing);

    // emulate progress attribute change
    let progress = 0;
    const el = document.querySelector('progress-ring');


    var listeProgramme = null;
    var url = "data/programs.json";
    var request = new XMLHttpRequest();
    request.open('GET', url);
    request.responseType = 'json';
    request.send();
    request.onload = function () {
        console.log(request.response);
        listeProgramme = request.response;
        populateTrainningList();
    };

    var synth = window.speechSynthesis;

    var voiceSelect = document.querySelector('#liste-voix');
    var trainningSelect = document.querySelector('#liste-trainning');

    var voices = [];


    function ditUnePhrase(text) {
        var utterThis = new SpeechSynthesisUtterance(text);
        var selectedOption = voiceSelect.selectedOptions[0].getAttribute('data-name');
        for (i = 0; i < voices.length; i++) {
            if (voices[i].name === selectedOption) {
                utterThis.voice = voices[i];
            }
        }
        utterThis.pitch = 1;
        utterThis.rate = 1;
        synth.speak(utterThis);

        return utterThis;
    }

    var etape = 0;
    var timer = 0;
    var car = 0;
    var interval = null;
    let isEnCours = false;
    let isPaused = false;
    let programme = null;


    function stopTrainning() {
        isEnCours = false;
        clearInterval(interval);
        gestionBtn();
        car = 0;
        timerDisplay();
    }

    function pauseTrainning() {
        isPaused = !isPaused;
        gestionBtn();
    }

    function startTrainning() {
        isEnCours = true;
        el.setProgress(0);
        gestionBtn();
        programme = listeProgramme[trainningSelect.selectedOptions[0].value];
        etape = 0;
        timer = 0;
        car = 0;
        interval = null;
        let texte = "Démarrage de l'entrainement " + programme.libelle;
        let speechTitle = ditUnePhrase(texte);

        speechTitle.onend = () => {
            let speechLibelle = ditUnePhrase(programme.etapes[etape].libelle);
            libelleDisplay(programme.etapes[etape].libelle);
            car = programme.etapes[etape].duree;
            speechLibelle.onend = () => {
                timerLoop();
            };
        };
    }

    function timerLoop() {
        interval = setInterval(() => {

            if (isPaused) return isPaused;
            if (!isEnCours) return isEnCours;

            car -= 1;
            timerDisplay();

            handleProgressRing();

            milestone();

            if (handleSteps()) return true;

        }, 1000);

    }

    function handleProgressRing() {
        let tActu = programme.etapes[etape].duree - car;
        let progress = tActu / programme.etapes[etape].duree * 100;

        console.log(progress);
        el.setAttribute('progress', progress);
    }

    function handleSteps() {
        if (car === 0) {
            etape++;
            if (programme.etapes[etape] === undefined) {
                ditUnePhrase("Fin de la scéance ! Bien joué.");
                libelleDisplay("Fin de la scéance ! Bien joué.");
                stopTrainning();
                return true;
            } else {
                isPaused = true;

                car = programme.etapes[etape].duree;
                let speechLibelle = ditUnePhrase(programme.etapes[etape].libelle);
                speechLibelle.onstart = _ =>{
                    el.setProgress(0);
                }
                speechLibelle.onend = () => {
                    isPaused = false;
                };
                libelleDisplay(programme.etapes[etape].libelle);
                timer = 1;
            }
        }
    }

    function milestone() {
        // if(programme.etapes[etape] === undefined) return true;
        switch (car) {
            case Math.round(programme.etapes[etape].duree) - 1:
                ditUnePhrase("C'est parti");
                break;
            case Math.round(programme.etapes[etape].duree / 2):
                ditUnePhrase("On est à la moitiée");
                break;
            case 3:
                // ditUnePhrase(car);
                ditUnePhrase(car);
                break;
            case 2:
                ditUnePhrase(car);
                break;
            case 1:
                ditUnePhrase(car);
                break;
            case 0:
                ditUnePhrase("Stop");
                break;
        }
    }

    function timerDisplay() {
        document.getElementById("temps").innerText = secToTime(car);
    }

    function libelleDisplay(text) {
        document.getElementById("sceance").innerText = text;
    }

    function secToTime(sec) {

        let log = document.getElementById("log");

        let pSec = document.getElementById("car");
        let pSecFoisTps = document.getElementById("carFoisTps");
        let pSecFoisTpsFloor = document.getElementById("carFoisTpsFloor");

        pSec.innerText = sec;
        pSecFoisTps.innerText = ((sec / 60) % 60).toString();
        pSecFoisTpsFloor.innerText = Math.floor((sec / 60) % 60).toString();

        let m = Math.floor((sec / 60) % 60);
        let s = sec % 60;
        return m.toString().padStart(2, '0') + ":" + s.toString().padStart(2, '0');
    }

    function populateVoiceList() {
        voices = synth.getVoices();

        for (let i = 0; i < voices.length; i++) {
            let option = document.createElement('option');
            option.textContent = voices[i].name + ' (' + voices[i].lang + ')';

            if (voices[i].default) {
                option.textContent += ' -- DEFAULT';
            }

            option.setAttribute('data-lang', voices[i].lang);
            option.setAttribute('data-name', voices[i].name);
            if (voices[i].lang === 'fr-FR') {
                option.selected = true;
            }
            voiceSelect.appendChild(option);
        }
    }

    function populateTrainningList() {

        for (let i = 0; i < listeProgramme.length; i++) {
            let option = document.createElement('option');
            option.textContent = listeProgramme[i].libelle;

            option.value = i;

            trainningSelect.appendChild(option);
        }
    }

    populateVoiceList();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoiceList;
    }


    function gestionBtn() {
        var btnStart = document.getElementById("btnStart");
        var btnPause = document.getElementById("btnPause");
        var btnStop = document.getElementById("btnStop");

        if (isEnCours) {
            btnStart.classList.add("disabled");
            btnPause.classList.remove("disabled");
            btnStop.classList.remove("disabled");
        } else {
            btnStart.classList.remove("disabled");
            btnPause.classList.add("disabled");
            btnStop.classList.add("disabled");
        }

        if (isPaused) {
            btnPause.innerText = "Play";
        } else {
            btnPause.innerText = "Pause";
        }
    }

</script>


</body>
</html>